#!/bin/bash

set -e

juju-log "Installing dependencies and upgrading system"
# TODO: make this optional for precise only
# apt-add-repository -y ppa:jaywink/curldebian
apt-get update && apt-get -y dist-upgrade
# TODO: make libmysqlclient-dev / libpq-dev choice depending on db, now just pgsql
apt-get -y install build-essential git curl imagemagick libmagickwand-dev nodejs redis-server libcurl4-openssl-dev libxml2-dev libxslt-dev libpq-dev apache2 sendmail

if [[ ! -e /home/diaspora ]]; then
    juju-log "Adding diaspora user"
    useradd -m -s /bin/bash diaspora
fi

cd /home/diaspora/

## TODO: run rvm upgrade if existing?
if [[ ! -e /home/diaspora/.rvm ]]; then
    juju-log "Install RVM"
    sudo -u diaspora -H bash -c "curl -L dspr.tk/1t | bash"
    echo '[[ -s "~/.rvm/scripts/rvm" ]] && source "~/.rvm/scripts/rvm"' >> /home/diaspora/.bashrc
fi

juju-log "Installing Ruby"
apt-get install -y gawk libreadline6-dev libyaml-dev libsqlite3-dev sqlite3 autoconf libgdbm-dev libncurses5-dev automake bison libffi-dev
sudo -u diaspora -H bash -c "source /home/diaspora/.bashrc; /home/diaspora/.rvm/bin/rvm install 2.0"

$CHARM_DIR/hooks/upgrade-diaspora
